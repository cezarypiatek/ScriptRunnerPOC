<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:avalonia="https://github.com/projektanker/icons.avalonia"
             xmlns:scriptConfigs="clr-namespace:ScriptRunner.GUI.ScriptConfigs"
             xmlns:viewModels="clr-namespace:ScriptRunner.GUI.ViewModels"
             xmlns:views="clr-namespace:ScriptRunner.GUI.Views"
             xmlns:mdxaml="https://github.com/whistyun/Markdown.Avalonia.Tight"
             xmlns:ctxt="clr-namespace:ColorTextBlock.Avalonia;assembly=ColorTextBlock.Avalonia"
             xmlns:converters="clr-namespace:ScriptRunner.GUI.Converters"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="450"
             x:DataType="viewModels:MainWindowViewModel"
             x:Class="ScriptRunner.GUI.Views.ActionDetailsSection">
  <UserControl.Resources>
    <converters:CategoryToColorConverter x:Key="CategoryToColorConverter"/>
    <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
  </UserControl.Resources>
  
    <Grid>
      <Grid.ColumnDefinitions>
        <!-- Left content: takes remaining space, but never below 200 -->
        <ColumnDefinition Width="*" MinWidth="900"/>

        <!-- Splitter column -->
        <ColumnDefinition Width="10"/>

        <!-- Right content: takes remaining space, but never below 250 -->
        <ColumnDefinition Width="*" MinWidth="350"/>
      </Grid.ColumnDefinitions>
      <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"  Margin="20, 0"  IsVisible="{Binding IsActionSelected, Mode=OneWay}">
      <!-- Custom collapsible header section -->
          <Border Background="#2A2A2E" BorderBrush="#48484E" BorderThickness="1" CornerRadius="8" Margin="0,0,0,15" BoxShadow="0 4 12 #60000000">
            <StackPanel>
              <!-- Header that's always visible -->
              <Grid ColumnDefinitions="*, Auto" Margin="16,16,16,4">
                <StackPanel Grid.Column="0" Orientation="Vertical" Spacing="8">
                  <Grid ColumnDefinitions="Auto, *">
                    <StackPanel Grid.Column="0" Orientation="Vertical">
                      <TextBlock FontSize="26" FontFamily="Inter" FontWeight="Bold" Foreground="#F0F0F0" TextWrapping="Wrap" Text="{Binding SelectedAction.Name}" />
                      
                      <!-- Description -->
                      <TextBlock FontSize="15" FontFamily="Inter" Foreground="#A0A0A0" Margin="0,4,0,0" IsVisible="{Binding SelectedAction.Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" Text="{Binding SelectedAction.Description}" TextWrapping="Wrap" LineHeight="22"/>
                    </StackPanel>
                  </Grid>

                  <!-- Categories as Pills -->
                  <ItemsControl Margin="0,8,0,0" ItemsSource="{Binding SelectedAction.Categories}" IsVisible="{Binding SelectedAction.Categories.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="{Binding Converter={StaticResource CategoryToColorConverter}}" 
                                CornerRadius="4" 
                                Padding="10,4" 
                                Margin="0,0,6,6"
                                BorderThickness="0">
                          <TextBlock Text="{Binding}" 
                                     FontSize="11" 
                                     FontWeight="SemiBold"
                                     Foreground="White"/>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <!-- Actions Column -->
                <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Top" Spacing="8">
                  <!-- Settings Menu -->
                  <Button HorizontalAlignment="Right" Background="Transparent" BorderThickness="0" Padding="8" Cursor="Hand" ToolTip.Tip="Action Settings">
                    <avalonia:Icon Value="fas fa-cog" Width="16" Height="16" Foreground="#A0A0A0" />
                    <Button.Styles>
                      <Style Selector="Button:pointerover /template/ ContentPresenter">
                        <Setter Property="Background" Value="#303035"/>
                        <Setter Property="Foreground" Value="White"/>
                      </Style>
                    </Button.Styles>
                    <Button.Flyout>
                      <MenuFlyout Placement="BottomEdgeAlignedRight" >
                        <MenuItem Header="Reinstall script" IsVisible="{Binding InstallAvailable}" Command="{Binding InstallScript}">
                          <MenuItem.Icon>
                            <avalonia:Icon Value="fas fa-sync" />
                          </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="Reset default settings"  Command="{Binding ResetDefaults}">
                          <MenuItem.Icon>
                            <avalonia:Icon Value="fas fa-undo" />
                          </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="Open containing dir in VSCode"  Command="{Binding OpenDirInVsCode}">
                          <MenuItem.Icon>
                            <avalonia:Icon Value="fas fa-folder-open" />
                          </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="Open definition in VSCode"  Command="{Binding OpenDefinitionInVsCode}">
                          <MenuItem.Icon>
                            <avalonia:Icon Value="fas fa-file-code" />
                          </MenuItem.Icon>
                        </MenuItem>
                      </MenuFlyout>
                    </Button.Flyout>
                  </Button>
                </StackPanel>
              </Grid>
              
              <!-- Collapsible details section -->
              <Border x:Name="DetailsSection" 
                      MaxHeight="0" 
                      ClipToBounds="True"
                      Opacity="0"
                      Background="#18181C"
                      BorderBrush="#48484E"
                      BorderThickness="0,1,0,0">
                <Border.Transitions>
                  <Transitions>
                    <DoubleTransition Property="MaxHeight" Duration="0:0:0.25" Easing="CubicEaseInOut"/>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.25" Easing="CubicEaseInOut"/>
                  </Transitions>
                </Border.Transitions>
                <StackPanel Margin="20">
                  <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                    <avalonia:Icon Value="fas fa-code-branch" Width="14" Height="14" Foreground="#808080" Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <TextBlock Text="Loaded from:" Foreground="#808080" VerticalAlignment="Center" FontSize="13"/>
                    <TextBlock FontWeight="SemiBold" Margin="6, 0" TextWrapping="Wrap" VerticalAlignment="Center" Foreground="#D0D0D0" FontSize="13">
                      <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0} [{1}]">
                          <Binding Path="SelectedAction.SourceName" />
                          <Binding Path="SelectedAction.Source" />
                        </MultiBinding>
                      </TextBlock.Text>
                    </TextBlock>
                  </StackPanel>
                  
                  <!-- Command Section -->
                  <Border Background="#121212" 
                           CornerRadius="6" 
                           BorderBrush="#48484E"
                           BorderThickness="1"
                           Padding="0">
                    <StackPanel>
                      <Border Background="#222226" CornerRadius="6,6,0,0" Padding="12,8" BorderBrush="#48484E" BorderThickness="0,0,0,1">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                          <avalonia:Icon Value="fas fa-terminal" Width="12" Height="12" Foreground="#A0A0A0" VerticalAlignment="Center"/>
                          <TextBlock FontSize="12" FontWeight="SemiBold" Foreground="#D0D0D0" VerticalAlignment="Center">Command Execution</TextBlock>
                        </StackPanel>
                      </Border>
                      <SelectableTextBlock Margin="12" TextWrapping="Wrap" Classes="consoleOutput" Inlines="{Binding SelectedAction.CommandFormatted}" FontFamily="Cascadia Code, Consolas, Monospace" FontSize="13"/>
                    </StackPanel>
                  </Border>
                  
                  <!-- Install Command Section (only shown if InstallCommand exists) -->
                  <StackPanel Margin="0,16,0,0" IsVisible="{Binding SelectedAction.InstallCommand, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <Border Background="#121212" 
                            CornerRadius="6" 
                            BorderBrush="#333338"
                            BorderThickness="1">
                      <StackPanel>
                        <Border Background="#1E1E22" CornerRadius="6,6,0,0" Padding="12,8" BorderBrush="#333338" BorderThickness="0,0,0,1">
                          <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                              <avalonia:Icon Value="fas fa-download" Width="12" Height="12" Foreground="#A0A0A0" VerticalAlignment="Center"/>
                              <TextBlock FontSize="12" FontWeight="SemiBold" Foreground="#D0D0D0" VerticalAlignment="Center">Install Command</TextBlock>
                            </StackPanel>
                            <Button Grid.Column="1" 
                                    Command="{Binding InstallScript}" 
                                    avalonia:Attached.Icon="fas fa-play"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Margin="0"
                                    Padding="6,2"
                                    FontSize="12"
                                    ToolTip.Tip="Run install command"
                                    Cursor="Hand">
                                    <Button.Styles>
                                      <Style Selector="Button:pointerover /template/ ContentPresenter">
                                        <Setter Property="Background" Value="#303035"/>
                                        <Setter Property="Foreground" Value="#4A9EFF"/>
                                      </Style>
                                    </Button.Styles>
                            </Button>
                          </Grid>
                        </Border>
                        <SelectableTextBlock Margin="12" TextWrapping="Wrap" Classes="consoleOutput" Inlines="{Binding SelectedAction.InstallCommandFormatted}" FontFamily="Cascadia Code, Consolas, Monospace" FontSize="13"/>  
                      </StackPanel>
                    </Border>
                  </StackPanel>
                </StackPanel>
              </Border>

              <!-- Footer / Toggle -->
              <Button 
                    HorizontalAlignment="Stretch" 
                    VerticalAlignment="Bottom"
                    Margin="0"
                    Background="Transparent"
                    BorderThickness="0,1,0,0"
                    BorderBrush="#2A2A30"
                    Padding="4"
                    Cursor="Hand"
                    Click="ToggleDetailsButton_Click">
                    <Button.Styles>
                      <Style Selector="Button:pointerover /template/ ContentPresenter">
                        <Setter Property="Background" Value="#25252A"/>
                      </Style>
                      <Style Selector="Button:pressed /template/ ContentPresenter">
                        <Setter Property="Background" Value="#151518"/>
                      </Style>
                    </Button.Styles>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                       <TextBlock x:Name="ToggleDetailsText" Text="Show details" FontSize="12" FontWeight="SemiBold" Foreground="#4A9EFF" VerticalAlignment="Center"/>
                       <avalonia:Icon x:Name="ToggleDetailsIcon" Value="fas fa-chevron-down" Width="10" Height="10" Foreground="#4A9EFF" VerticalAlignment="Center"/>
                    </StackPanel>
              </Button>
            </StackPanel>
          </Border>
              
          <Button Grid.Row="1"  Margin="0,10,0,0" IsVisible="{Binding !SelectedActionInstalled}" Command="{Binding InstallScript}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center">Install</Button>
             
          <StackPanel Grid.Row="2"  IsEnabled="{Binding SelectedActionInstalled}">
            <StackPanel IsVisible="{Binding HasParams}">
              <Border Background="#2A2A2E" BorderBrush="#48484E" BorderThickness="1" CornerRadius="8" Padding="15" Margin="0,0,0,15" BoxShadow="0 4 12 #60000000">
                   <Grid ColumnDefinitions="Auto,*,Auto" HorizontalAlignment="Stretch" VerticalAlignment="Center">
                   
                <TextBlock Classes="h2"
                           VerticalAlignment="Center"
                           Text="Predefined parameters: "
                           FontWeight="SemiBold"
                           Foreground="#D0D0D0"
                           Grid.Column="0"></TextBlock>
                <ComboBox Margin="15,0,15,0"
                          Grid.Column="1"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Stretch"
                          ItemsSource="{Binding SelectedAction.PredefinedArgumentSets}"
                          SelectedItem="{Binding SelectedArgumentSet, Mode=TwoWay}"
                >
                  <ComboBox.DataTemplates>
                    <DataTemplate x:DataType="scriptConfigs:ArgumentSet">
                      <TextBlock Text="{Binding Description}"></TextBlock>
                    </DataTemplate>
                  </ComboBox.DataTemplates>
                </ComboBox>
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                  <Button 
                    avalonia:Attached.Icon="far fa-save"
                    Padding="8"
                    Margin="0"
                    ToolTip.Tip="Save current parameters as predefined set"  
                    Click="SaveCurrentParametersAsPredefined" 
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="1"
                    BorderBrush="#48484E"
                    CornerRadius="4"
                    Foreground="#A0A0A0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#303035"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="BorderBrush" Value="#4A9EFF"/>
                        </Style>
                    </Button.Styles>
                  </Button>
                  <Button 
                    avalonia:Attached.Icon="far fa-copy"
                    Padding="8"
                    Margin="0"
                    ToolTip.Tip="Copy current parameters to clipboard"  
                    Command="{Binding CopyParametersSetup}" 
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="1"
                    BorderBrush="#48484E"
                    CornerRadius="4"
                    Foreground="#A0A0A0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#303035"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="BorderBrush" Value="#4A9EFF"/>
                        </Style>
                    </Button.Styles>
                  </Button>
                  <Button 
                    avalonia:Attached.Icon="far fa-paste"
                    Padding="8"
                    Margin="0"
                    ToolTip.Tip="Paste parameters from clipboard"  
                    Command="{Binding PasteParametersSetup}" 
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="1"
                    BorderBrush="#48484E"
                    CornerRadius="4"
                    Foreground="#A0A0A0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#303035"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="BorderBrush" Value="#4A9EFF"/>
                        </Style>
                    </Button.Styles>
                  </Button>
                </StackPanel>

              </Grid>
              </Border>
            
            </StackPanel>
            
          </StackPanel>
          <Border Grid.Row="3" Background="#2A2A2E" BorderBrush="#48484E" BorderThickness="1" CornerRadius="8" Padding="15" Margin="0,0,0,0" BoxShadow="0 4 12 #60000000" IsEnabled="{Binding SelectedActionInstalled}">
            <ScrollViewer ScrollChanged="OnActionPanelScrollChange"  BringIntoViewOnFocusChange="False" >
              <ItemsControl ItemsSource="{Binding ActionParametersPanel}">
                <ItemsControl.Styles>
                  <Style Selector="ItemsPresenter">
                    <Setter Property="(KeyboardNavigation.TabNavigation)" Value="Continue" />
                  </Style>
                </ItemsControl.Styles>
              </ItemsControl>
            </ScrollViewer>
          </Border>
          <DockPanel Grid.Row="4"  Margin="0, 15, 0 , 15" HorizontalAlignment="Stretch" IsEnabled="{Binding SelectedActionInstalled}">
            <Button Classes="primary" DockPanel.Dock="Right"  HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" Command="{Binding RunScript}">Run</Button>

          </DockPanel>
        </Grid>
      <GridSplitter Grid.Column="1" MinWidth="2" HorizontalAlignment="Center" Background="#FF3E3E40"></GridSplitter>
      <TabControl Grid.Column="2"  SelectedIndex="{}">
        <TabItem IsVisible="{Binding SelectedAction.HasDocs}" Header="Documentation">
          <Border Grid.Column="1" Background="#0d1117" IsVisible="{Binding SelectedAction.HasDocs}" HorizontalAlignment="Stretch">
            <mdxaml:MarkdownScrollViewer xml:space="default" SelectionEnabled="True" Margin="20"  Markdown="{Binding SelectedAction.DocsContent}" AssetPathRoot="{Binding SelectedAction.DocAssetPath}" HorizontalAlignment="Stretch">
              <mdxaml:MarkdownScrollViewer.Styles>
                <Style Selector="ctxt|CTextBlock">
                  <Setter Property="Foreground" Value="#f0f6fc"/>
                </Style>
                <Style Selector="ctxt|CTextBlock.Heading1">
                  <Setter Property="Foreground" Value="#f0f6fc"/>
                  <Setter Property="FontWeight" Value="Bold"/>
                </Style>
                <Style Selector="ctxt|CTextBlock.Heading2">
                  <Setter Property="Foreground" Value="#f0f6fc"/>
                  <Setter Property="FontWeight" Value="Bold"/>
                </Style>
                <Style Selector="ctxt|CTextBlock.Heading3">
                  <Setter Property="Foreground" Value="#f0f6fc"/>
                  <Setter Property="FontWeight" Value="Bold"/>
                </Style>
                <Style Selector="ctxt|CTextBlock.Heading4">
                  <Setter Property="Foreground" Value="#f0f6fc"/>
                  <Setter Property="FontWeight" Value="Bold"/>
                </Style>
                <Style Selector=".Markdown_Avalonia_MarkdownViewer ctxt|CCode">
                  <Style.Setters>
                    <Setter Property="BorderThickness"     Value="0"/>
                    <Setter Property="Padding"             Value="5,2"/>
                    <Setter Property="MonospaceFontFamily" Value="Meiryo" />
                    <Setter Property="Foreground"          Value="#D0D0D0" />
                    <Setter Property="Background"          Value="#3C3C3C" />
                  </Style.Setters>
                </Style>

              </mdxaml:MarkdownScrollViewer.Styles>
            </mdxaml:MarkdownScrollViewer>
          </Border>
        </TabItem>
        <TabItem Header="History" IsSelected="{Binding !SelectedAction.HasDocs}">
          <Grid RowDefinitions="Auto,*">
            <StackPanel Orientation="Vertical">
              <TextBox Watermark="Search" Text="{Binding TermForCurrentHistoryFilter}"></TextBox>
              <CheckBox IsChecked="{Binding CompactedHistoryForCurrent}" ToolTip.Tip="Show latest execution with the same parameters">Compacted</CheckBox>
            </StackPanel>
            <Panel Grid.Row="1">
              <views:ExecutionLogList
                                      Items="{Binding ExecutionLogForCurrent}"
                                      SelectedItem="{Binding SelectedRecentExecution, Mode=TwoWay}"
                                      ShowDatePicker="True"/>
            </Panel>

          </Grid>
        </TabItem>
      </TabControl>

    </Grid>
  
  
</UserControl>
